<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasir Itemku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .form-control, .form-select { padding: 12px; font-size: 1rem; border-radius: 10px; }
        .btn-qty { width: 45px; font-weight: bold; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        optgroup { font-weight: bold; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container-fluid p-0 bg-white shadow-sm sticky-top mb-3">
        <div class="d-flex align-items-center p-3">
            <a href="/" class="btn btn-light me-3 border">‚Üê</a>
            <h5 class="fw-bold m-0">üõí Input Order Baru</h5>
        </div>
    </div>

    <div class="container px-3 pb-5">
        <form action="/process-order" method="POST" onsubmit="this.querySelector('button[type=submit]').disabled=true">
           
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="text-primary fw-bold mb-3">DATA PESANAN</h6>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">Produk / Layanan</label>
                        <select id="productSelect" class="form-select fw-bold text-dark" onchange="updateProduct()">
                            <% products.forEach(p => { %>
                                <option value="<%= p.name %>" data-price="<%= p.price %>"><%= p.name %> (Modal: <%= p.price %>)</option>
                            <% }) %>
                            <option value="custom" data-price="0">-- Input Manual --</option>
                        </select>
                        <input type="hidden" name="item" id="realItemName">
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-7">
                            <label class="form-label text-muted small">Total Beban (Diamond)</label>
                            <input type="number" name="qty" id="totalCost" class="form-control bg-light text-start fw-bold text-danger" readonly>
                        </div>
                        <div class="col-5">
                            <label class="form-label text-muted small text-end d-block">Jumlah (Qty)</label>
                            <div class="input-group justify-content-end">
                                <button type="button" class="btn btn-outline-secondary btn-qty" onclick="modQty(-1)">-</button>
                                <input type="number" id="qtyInput" class="form-control text-center fw-bold px-0" value="1" min="1" oninput="calculateTotal()">
                                <button type="button" class="btn btn-outline-primary btn-qty" onclick="modQty(1)">+</button>
                            </div>
                        </div>
                    </div>

                    <hr class="border-light my-3">

                    <div class="mb-3">
                        <label class="form-label text-muted small">Nomor Pesanan</label>
                        <input type="text" name="orderId" class="form-control fw-bold" placeholder="ODxxxxxxxxxxx" required>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-5">
                            <input type="text" name="targetId" class="form-control" placeholder="ID Game" required>
                        </div>
                        <div class="col-3">
                            <input type="text" name="targetZone" class="form-control" placeholder="Server" required>
                        </div>
                        <div class="col-4">
                            <input type="text" name="targetNick" class="form-control" placeholder="Nickname">
                        </div>
                    </div>

                    <div class="mb-2">
                        <input type="text" name="buyer" class="form-control" placeholder="Nama Pembeli (Itemku)" required>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="text-success fw-bold mb-2">SUMBER DANA</h6>
                    <small class="text-muted d-block mb-3" id="helperText">Menghitung rekomendasi...</small>
                    <select name="akunAdmin" id="accountSelector" class="form-select bg-light fw-bold" required>
                        <option value="" disabled selected>-- Sedang Memuat --</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow rounded-3" style="font-size: 1.1rem;">üöÄ PROSES ORDER</button>
        </form>
    </div>

    <script>
        const accountsData = <%- JSON.stringify(accounts) %>;

        window.onload = function() {
            updateProduct();
        };

        function updateProduct() {
            const select = document.getElementById('productSelect');
            const selectedOpt = select.options[select.selectedIndex];
            const price = parseInt(selectedOpt.getAttribute('data-price'));
            window.currentBasePrice = price; 
            
            const qty = parseInt(document.getElementById('qtyInput').value) || 1;
            const itemName = selectedOpt.value === 'custom' ? 'Custom Item' : selectedOpt.value;
            document.getElementById('realItemName').value = `${qty}x ${itemName}`;

            calculateTotal();
        }

        function modQty(val) {
            const el = document.getElementById('qtyInput');
            let newVal = parseInt(el.value) + val;
            if (newVal < 1) newVal = 1;
            el.value = newVal;
            updateProduct();
        }

        function calculateTotal() {
            const qty = parseInt(document.getElementById('qtyInput').value) || 1;
            let unitPrice = window.currentBasePrice;
            let totalPrice = unitPrice * qty;

            document.getElementById('totalCost').value = totalPrice;
            document.getElementById('helperText').innerText = `Mencari kombinasi akun untuk ${qty} item (@${unitPrice})...`;
            
            // Panggil render dengan Harga Total DAN Harga Satuan
            renderAccountList(totalPrice, unitPrice, qty);
        }

        function renderAccountList(totalCost, unitPrice, qty) {
            const select = document.getElementById('accountSelector');
            select.innerHTML = '<option value="" disabled selected>-- Pilih Metode Pengiriman --</option>';

            // 1. CARI SINGLE FIGHTER (1 Akun borong semua)
            // Syarat: Aset >= Total Harga
            let singleCandidates = [];
            accountsData.forEach(acc => {
                const potWdp = Math.min((acc.wdp_days || 0) * 20, 140); 
                const totalAsset = acc.diamond + potWdp;
                
                // Klasifikasi Status
                let status = "üî¥";
                if (acc.diamond >= totalCost) status = "üü¢"; // Available Real
                else if (totalAsset >= totalCost) status = "üîµ"; // Forecast
                
                if (totalAsset >= totalCost) { // Masukkan yang mampu saja
                    singleCandidates.push({
                        ...acc,
                        label: `${status} ${acc.nick} (Single Cover)`,
                        val: acc.nick
                    });
                }
            });

            // 2. CARI COMBO SQUAD (Hanya jika Qty > 1)
            // Syarat: Cari N akun yang masing-masing asetnya >= Harga Satuan
            let comboOption = null;
            if (qty > 1) {
                // Filter akun yang mampu beli SATUAN
                let capableAccounts = accountsData.filter(acc => {
                    const potWdp = Math.min((acc.wdp_days || 0) * 20, 140);
                    return (acc.diamond + potWdp) >= unitPrice;
                });

                // Urutkan dari saldo terbanyak (Strategy: Secure Stock first)
                capableAccounts.sort((a, b) => b.diamond - a.diamond);

                // Jika jumlah akun mampu >= Qty yang diminta
                if (capableAccounts.length >= qty) {
                    // Ambil N akun teratas
                    const squad = capableAccounts.slice(0, qty);
                    const nicks = squad.map(a => a.nick).join(',');
                    const display = squad.map(a => a.nick).join(' & ');
                    
                    comboOption = {
                        label: `‚ú® COMBO: ${display} (Split Order)`,
                        val: nicks // Value dipisah koma: "arda1,arda2"
                    };
                }
            }

            // --- RENDER KE DROPDOWN ---

            // Opsi Combo (Prioritas jika Single tidak ada, atau sebagai alternatif)
            if (comboOption) {
                const grp = document.createElement('optgroup');
                grp.label = "‚ö° REKOMENDASI SPLIT (COMBO)";
                const opt = document.createElement('option');
                opt.value = comboOption.val;
                opt.innerText = comboOption.label;
                grp.appendChild(opt);
                select.appendChild(grp);
            }

            // Opsi Single
            if (singleCandidates.length > 0) {
                // Urutkan: Available (Real) dulu, baru Forecast
                singleCandidates.sort((a, b) => b.diamond - a.diamond);
                
                const grp = document.createElement('optgroup');
                grp.label = "üë§ AKUN TUNGGAL (SINGLE)";
                singleCandidates.forEach(cand => {
                    const opt = document.createElement('option');
                    opt.value = cand.val;
                    opt.innerText = cand.label;
                    grp.appendChild(opt);
                });
                select.appendChild(grp);
            }

            // Fallback jika kosong
            if (singleCandidates.length === 0 && !comboOption) {
                const opt = document.createElement('option');
                opt.innerText = "‚ùå Tidak ada akun/kombinasi yang mencukupi!";
                opt.disabled = true;
                select.appendChild(opt);
            } else {
                select.selectedIndex = 1; // Auto select opsi pertama valid
            }
        }
    </script>

</body>
</html>
