<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hai Imam - Market Intel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .row-me { background-color: #e8f0fe !important; border-left: 4px solid #0d6efd; }
        .badge-rank { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; background: #eee; border-radius: 50%; font-size: 0.7rem; font-weight: bold; }
        .chart-box { height: 250px; position: relative; }
    </style>
</head>
<body class="p-3">

    <div class="container" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold"><i class="fas fa-radar text-primary"></i> Market Radar</h4>
            <a href="/" class="btn btn-light shadow-sm"><i class="fas fa-home"></i></a>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <label class="form-label fw-bold small text-muted">TARGET URL</label>
                <div class="input-group">
                    <input type="text" id="urlInput" class="form-control" value="https://api-gateway.itemku.com/v2/product/search?is_include_game=1&is_include_item_type=1&is_include_item_info_group=0&is_include_item_info=1&is_include_order_record=1&is_from_web=1&exclude_sharing_account_eligible=1&use_simple_pagination=1&per_page=60&page=1&sort=cheap&is_default_product_list=0&is_auto_delivery_first=0&is_enough_stock=1&platform_id=2&query=starlight%20card&is_exclusive=false&is_include_instant_delivery=true&country_codes[]=ID
">
                    <button class="btn btn-primary fw-bold px-4" onclick="analisa()">
                        <i class="fas fa-search"></i> SCAN
                    </button>
                </div>
            </div>
        </div>

        <div id="resultArea" style="display: none;">
            
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="card bg-success text-white text-center p-3 h-100">
                        <small>Termurah</small>
                        <h4 class="fw-bold m-0" id="resLow">Rp 0</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card bg-white text-dark text-center p-3 h-100 border">
                        <small>Total Toko</small>
                        <h4 class="fw-bold m-0" id="resCount">0</h4>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card bg-primary text-white text-center p-3 h-100">
                        <small>Posisi "Hai Imam"</small>
                        <h4 class="fw-bold m-0" id="resRank">-</h4>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card p-3">
                        <h6 class="fw-bold small text-muted mb-3">Dominasi Penjualan (Top 5)</h6>
                        <div class="chart-box"><canvas id="shareChart"></canvas></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3">
                        <h6 class="fw-bold small text-muted mb-3">Komparasi Harga</h6>
                        <div class="chart-box"><canvas id="priceChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-white py-3">
                    <h6 class="fw-bold m-0"><i class="fas fa-list text-primary"></i> Data Kompetitor</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light small text-muted text-uppercase">
                            <tr>
                                <th class="text-center">#</th>
                                <th>Toko</th>
                                <th>Harga</th>
                                <th class="text-center">Sold</th>
                                <th class="text-center text-danger">Gagal</th>
                                <th class="text-center">Stok</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="small fw-medium"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart1 = null, chart2 = null;

        async function analisa() {
            const btn = document.querySelector('button');
            const url = document.getElementById('urlInput').value;
            
            btn.innerHTML = 'Scan...'; btn.disabled = true;

            try {
                const res = await fetch('/api/scan-price', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: url })
                });
                const json = await res.json();

                if (json.success) {
                    renderUI(json.data);
                } else {
                    alert(json.message);
                }
            } catch (e) { alert('Error koneksi'); } 
            finally { btn.innerHTML = '<i class="fas fa-search"></i> SCAN'; btn.disabled = false; }
        }

        function renderUI(data) {
            document.getElementById('resLow').innerText = "Rp " + data.lowPrice.toLocaleString();
            document.getElementById('resCount').innerText = data.competitors;
            document.getElementById('resRank').innerText = data.myRank;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.allCompetitors.forEach(item => {
                const isMe = item.isMe;
                const row = `
                    <tr class="${isMe ? 'row-me' : ''}">
                        <td class="text-center"><span class="badge-rank">${item.rank}</span></td>
                        <td>${item.name} ${isMe ? '<i class="fas fa-check-circle text-primary"></i>' : ''}</td>
                        <td class="text-success fw-bold">Rp ${item.price.toLocaleString()}</td>
                        <td class="text-center fw-bold">${item.sales}</td>
                        <td class="text-center ${item.failed > 0 ? 'text-danger fw-bold' : 'text-muted'}">${item.failed}</td>
                        <td class="text-center text-muted">${item.stock}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('resultArea').style.display = 'block';
            renderCharts(data.allCompetitors);
        }

        function renderCharts(list) {
            // Ambil Top 5 + Toko Sendiri
            let top = list.slice(0, 5);
            const myData = list.find(x => x.isMe);
            if(myData && !top.includes(myData)) top.push(myData);

            const labels = top.map(x => x.isMe ? "SAYA" : x.name.substring(0, 10));
            const sales = top.map(x => x.sales);
            const prices = top.map(x => x.price);
            const colors = top.map(x => x.isMe ? '#0d6efd' : '#e9ecef');

            if(chart1) chart1.destroy();
            chart1 = new Chart(document.getElementById('shareChart'), {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: sales, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            if(chart2) chart2.destroy();
            chart2 = new Chart(document.getElementById('priceChart'), {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Harga', data: prices, backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });
        }
    </script>
</body>
</html>
