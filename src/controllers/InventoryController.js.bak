const Account = require('../models/Account');
const Log = require('../models/Log');

class InventoryController {
    
    static async index(req, res) {
        try {
            const rawAccounts = await Account.getAll();
            
            // MAPPING KHUSUS SESUAI STRUKTUR DATAMU (nick, wdp_days, pending_wdp)
            const accounts = rawAccounts.map(acc => {
                return {
                    nickname: acc.nick || acc.nickname || 'Tanpa Nama',
                    id: acc.id || '-',
                    diamond: parseInt(acc.diamond || 0),
                    wdp_remaining: parseInt(acc.wdp_days || acc.wdp_remaining || 0),
                    pending_wdp: !!(acc.pending_wdp),
                    last_req: acc.last_req || null
                };
            });

            // Hitung Total Aset Diamond (Bukan WDP)
            const totalDiamond = accounts.reduce((sum, acc) => sum + acc.diamond, 0);
            
            res.render('inventory', { 
                page: 'inventory',
                accounts,
                totalDiamond,
                err: req.query.err || null
            });

        } catch (error) {
            console.error("[INVENTORY ERROR]", error);
            res.render('inventory', { page: 'inventory', accounts: [], totalDiamond: 0, err: null });
        }
    }

    static async updateStock(req, res) {
        try {
            const { nickname, action, amount, days, notes, penyesuaian } = req.body;
            const isPenyesuaian = penyesuaian === '1' || penyesuaian === 'true' || penyesuaian === true;
            let accounts = await Account.getAll();
            
            const accountIndex = accounts.findIndex(a => 
                (a.nick || '').toLowerCase() === (nickname || '').toLowerCase()
            );

            if (accountIndex === -1) {
                console.log(`❌ Gagal update: Akun dengan nick '${nickname}' tidak ditemukan.`);
                return res.redirect('/inventory');
            }

            let account = accounts[accountIndex];
            if (account.diamond === undefined) account.diamond = 0;
            if (account.wdp_days === undefined) account.wdp_days = 0;

            let logMessage = "";
            let change = 0;
            let addDM = 0, addDays = 0;

            switch (action) {
                case 'inject_wdp': {
                    const qty = parseInt(amount) || 0;
                    addDM = qty * 80;
                    addDays = qty * 7;
                    account.diamond += addDM;
                    account.wdp_days += addDays;
                    logMessage = `[INJECT] ${account.nick}: +${qty} Paket (+${addDM} DM, +${addDays} Hari)`;
                    break;
                }
                case 'manual_dm':
                    change = parseInt(amount) || 0;
                    account.diamond += change;
                    addDM = change;
                    logMessage = `[MANUAL] ${account.nick}: Diamond ${change > 0 ? '+' : ''}${change}`;
                    break;

                case 'manual_days':
                    change = parseInt(days) || 0;
                    account.wdp_days += change;
                    if (account.wdp_days < 0) account.wdp_days = 0;
                    addDays = change;
                    logMessage = `[MANUAL] ${account.nick}: WDP ${change > 0 ? '+' : ''}${change} Hari`;
                    break;
            }

            // Mode Penyesuaian (hutang) vs Biasa (real)
            if (isPenyesuaian) {
                account.pending_wdp = true;
                if (!account.last_req || typeof account.last_req !== 'object') account.last_req = { dm: 0, days: 0 };
                if (action === 'inject_wdp') {
                    account.last_req.dm = (account.last_req.dm || 0) + addDM;
                    account.last_req.days = (account.last_req.days || 0) + addDays;
                } else if (action === 'manual_dm') {
                    account.last_req.dm = (account.last_req.dm || 0) + change;
                } else if (action === 'manual_days') {
                    account.last_req.days = (account.last_req.days || 0) + change;
                }
                logMessage += ' [PENYESUAIAN / HUTANG]';
            } else {
                account.pending_wdp = false;
                if (account.last_req) delete account.last_req;
                logMessage += ' [REAL]';
            }

            await Account.saveAll(accounts);
            await Log.create(logMessage);

            console.log(`✅ Sukses Update: ${logMessage}`);
            res.redirect('/inventory');

        } catch (error) {
            console.error("[UPDATE ERROR]", error);
            res.status(500).send("Gagal update data.");
        }
    }

    static async deleteAccount(req, res) {
        try {
            const { nickname } = req.body;
            let accounts = await Account.getAll();
            
            // Filter hapus berdasarkan 'nick'
            const newAccounts = accounts.filter(a => a.nick !== nickname);
            
            await Account.saveAll(newAccounts);
            await Log.create(`[DELETE] Menghapus akun: ${nickname}`);
            res.redirect('/inventory');
        } catch (error) {
            res.status(500).send("Gagal hapus akun.");
        }
    }
}

module.exports = InventoryController;