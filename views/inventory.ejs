<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gudang Akun</title>
    <link rel="stylesheet" href="/css/store.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script> 
</head>
<body>

    <div class="header">
        <h1>Gudang Akun</h1>
        <button class="btn" style="width: auto; padding: 8px 12px; background: #f0f2f5; color: var(--primary);" onclick="alert('Tambah akun manual di file accounts.json untuk saat ini.')">
            <i class="ph-bold ph-plus"></i> Baru
        </button>
    </div>

    <div class="container">
        <div class="card" style="background: linear-gradient(135deg, #007AFF 0%, #0055FF 100%); color: white; border:none;">
            <div class="flex-row">
                <div>
                    <span style="font-size: 13px; opacity: 0.9;">Total Aset Diamond</span>
                    <div style="font-size: 28px; font-weight: 800; margin-top: 5px;">
                        <%= typeof totalDiamond !== 'undefined' ? totalDiamond.toLocaleString('id-ID') : 0 %> 
                        <span style="font-size: 14px; font-weight: 500;">DM</span>
                    </div>
                </div>
                <i class="ph-duotone ph-diamond" style="font-size: 40px; opacity: 0.8;"></i>
            </div>
        </div>

        <h3 style="margin: 25px 0 10px; font-size: 13px; text-transform: uppercase; color: #888; letter-spacing: 1px;">
            Daftar Akun (<%= accounts.length %>)
        </h3>

        <% if (accounts && accounts.length > 0) { %>
            <% accounts.forEach(acc => { %>
                <div class="card" onclick="bukaKelola('<%= acc.nickname %>', '<%= acc.id %>', <%= acc.diamond %>, <%= acc.wdp_remaining %>)">
                    <div class="flex-row">
                        <div style="display:flex; align-items:center; gap: 12px;">
                            
                            <div style="background: #E5F1FF; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                <i class="ph-fill ph-game-controller" style="font-size: 24px;"></i>
                            </div>
                            
                            <div>
                                <span class="account-name"><%= acc.nickname %></span>
                                <div class="account-meta">
                                    <i class="ph-bold ph-identification-card"></i> 
                                    <%= acc.id %>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right;">
                            <div class="diamond-count"><%= acc.diamond.toLocaleString('id-ID') %></div>
                            
                            <% if(acc.wdp_remaining > 0) { %>
                                <span class="badge bg-green" style="display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="ph-fill ph-calendar-check" style="font-size: 12px;"></i> 
                                    <%= acc.wdp_remaining %>h
                                </span>
                            <% } else { %>
                                <span class="badge bg-red" style="display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="ph-fill ph-calendar-x" style="font-size: 12px;"></i> 
                                    Habis
                                </span>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div style="text-align: center; padding: 50px; color: #999;">
                <i class="ph-duotone ph-ghost" style="font-size: 48px; margin-bottom: 10px;"></i><br>
                Database Kosong.
            </div>
        <% } %>
    </div>

<div class="modal-overlay" id="overlay" onclick="tutupModal()"></div>
    <div class="bottom-sheet" id="sheet">
        <div class="sheet-handle"></div>
        <div style="text-align: center; margin-bottom: 25px;">
            <h3 id="modalTitle" style="margin:0; font-size: 20px;">-</h3>
            <p id="modalSub" style="margin: 5px 0 0; color: #888; font-size: 14px;">-</p>
        </div>

        <div class="tabs-nav">
            <div class="tab-item active" onclick="gantiTab('tab-inject', this)">
                <i class="ph-bold ph-syringe" style="font-size: 18px;"></i> Inject
            </div>
            <div class="tab-item" onclick="gantiTab('tab-koreksi', this)">
                <i class="ph-bold ph-sliders-horizontal" style="font-size: 18px;"></i> Koreksi
            </div>
            <div class="tab-item" onclick="gantiTab('tab-hapus', this)">
                <i class="ph-bold ph-trash-simple" style="font-size: 18px;"></i> Hapus
            </div>
        </div>

        <div id="tab-inject" class="tab-content active">
            <form action="/api/update-stok" method="POST">
                <input type="hidden" name="nickname" class="target-nick">
                <input type="hidden" name="action" value="inject_wdp">
                
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Paket WDP Masuk:</p>
                <div class="grid-3">
                    <button type="button" class="btn-big" onclick="setWdp(1)"><i class="ph-bold ph-package"></i> 1x</button>
                    <button type="button" class="btn-big" onclick="setWdp(2)"><i class="ph-bold ph-package"></i> 2x</button>
                    <button type="button" class="btn-big" onclick="setWdp(5)"><i class="ph-bold ph-package"></i> 5x</button>
                </div>
                <div class="flex-row" style="gap: 10px;">
                    <input type="number" name="amount" id="wdpInput" class="input-box" placeholder="Jml Paket WDP" required style="margin-bottom:0;">
                    <button type="submit" class="btn-primary" style="width: 120px; margin-bottom:0;">Simpan</button>
                </div>
            </form>
        </div>

        <div id="tab-koreksi" class="tab-content">
            <form action="/api/update-stok" method="POST" style="margin-bottom: 15px;">
                <input type="hidden" name="nickname" class="target-nick">
                <input type="hidden" name="action" value="manual_dm">
                <label style="font-size:12px; color:#666;">Edit Diamond Manual</label>
                <div class="flex-row" style="gap:10px;">
                    <input type="number" name="amount" class="input-box" placeholder="+/- (Contoh: -50)" style="margin:0">
                    <button type="submit" class="btn" style="width:auto; background:#eee; margin:0">Ok</button>
                </div>
            </form>
            <form action="/api/update-stok" method="POST">
                <input type="hidden" name="nickname" class="target-nick">
                <input type="hidden" name="action" value="manual_days">
                <label style="font-size:12px; color:#666;">Edit Hari Manual</label>
                <div class="flex-row" style="gap:10px;">
                    <input type="number" name="days" class="input-box" placeholder="+/- (Contoh: +1)" style="margin:0">
                    <button type="submit" class="btn" style="width:auto; background:#eee; margin:0">Ok</button>
                </div>
            </form>
        </div>

        <div id="tab-hapus" class="tab-content">
             <form action="/api/delete-account" method="POST" onsubmit="return confirm('Hapus permanen?');">
                <input type="hidden" name="nickname" class="target-nick">
                <button type="submit" class="btn-danger"><i class="ph-bold ph-trash"></i> Hapus Akun</button>
            </form>
        </div>
    </div>

    <%- include('partials/bottom_nav') %>

    <script>
        function bukaKelola(nick, id, dm, days) {
            document.getElementById('modalTitle').innerText = nick;
            document.getElementById('modalSub').innerText = `ID: ${id} • ${parseInt(dm).toLocaleString()} DM • ${days} Hari`;
            
            // Set value ke semua hidden input class 'target-nick'
            document.querySelectorAll('.target-nick').forEach(el => el.value = nick);
            
            gantiTab('tab-inject', document.querySelector('.tab-item'));
            document.getElementById('overlay').classList.add('active');
            document.getElementById('sheet').classList.add('active');
        }

        function tutupModal() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('sheet').classList.remove('active');
        }

        function gantiTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function setWdp(n) { document.getElementById('wdpInput').value = n; }
    </script>
</body>
</html>