<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gudang Akun</title>
    <link rel="stylesheet" href="/css/store.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script> 
</head>
<body>

    <div class="header">
        <h1>Gudang Akun</h1>
        <button type="button" class="btn" style="width: auto; padding: 8px 12px; background: var(--primary); color: #fff;" onclick="bukaModalTambah()">
            <i class="ph-bold ph-plus"></i> Tambah Akun
        </button>
    </div>

    <div class="container">
        <div class="card" style="background: linear-gradient(135deg, #007AFF 0%, #0055FF 100%); color: white; border:none;">
            <div class="flex-row">
                <div>
                    <span style="font-size: 13px; opacity: 0.9;">Total Aset Diamond</span>
                    <div style="font-size: 28px; font-weight: 800; margin-top: 5px;">
                        <%= typeof totalDiamond !== 'undefined' ? totalDiamond.toLocaleString('id-ID') : 0 %> 
                        <span style="font-size: 14px; font-weight: 500;">DM</span>
                    </div>
                </div>
                <i class="ph-duotone ph-diamond" style="font-size: 40px; opacity: 0.8;"></i>
            </div>
        </div>

        <% if (typeof err !== 'undefined' && err === 'duplicate') { %>
        <div style="background: #fef3c7; color: #92400e; padding: 10px 14px; border-radius: 12px; margin-bottom: 12px; font-size: 13px;">
            Nick sudah dipakai. Gunakan nickname lain.
        </div>
        <% } %>
        <h3 style="margin: 25px 0 10px; font-size: 13px; text-transform: uppercase; color: #888; letter-spacing: 1px;">
            Daftar Akun (<%= accounts.length %>)
        </h3>

        <% if (accounts && accounts.length > 0) { %>
            <% accounts.forEach(acc => { %>
                <div class="card" onclick="bukaKelola('<%= acc.nickname %>', '<%= acc.id %>', <%= acc.diamond %>, <%= acc.wdp_remaining %>)">
                    <div class="flex-row">
                        <div style="display:flex; align-items:center; gap: 12px;">
                            
                            <div style="background: #E5F1FF; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                <i class="ph-fill ph-game-controller" style="font-size: 24px;"></i>
                            </div>
                            
                            <div>
                                <span class="account-name"><%= acc.nickname %></span>
                                <div class="account-meta">
                                    <i class="ph-bold ph-identification-card"></i> 
                                    <%= acc.id %>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right;">
                            <div class="diamond-count"><%= acc.diamond.toLocaleString('id-ID') %></div>
                            <% if (acc.pending_wdp) { %>
                                <span class="badge" style="display: inline-flex; align-items: center; gap: 4px; background: #f59e0b; color: #fff; font-size: 11px; margin-bottom: 4px;">
                                    <i class="ph-fill ph-warning" style="font-size: 12px;"></i> Hutang
                                </span><br>
                            <% } %>
                            <% if(acc.wdp_remaining > 0) { %>
                                <span class="badge bg-green" style="display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="ph-fill ph-calendar-check" style="font-size: 12px;"></i> 
                                    <%= acc.wdp_remaining %>h
                                </span>
                            <% } else { %>
                                <span class="badge bg-red" style="display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="ph-fill ph-calendar-x" style="font-size: 12px;"></i> 
                                    Habis
                                </span>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div style="text-align: center; padding: 50px; color: #999;">
                <i class="ph-duotone ph-ghost" style="font-size: 48px; margin-bottom: 10px;"></i><br>
                Database Kosong.
            </div>
        <% } %>
    </div>

    <!-- Modal Tambah Akun Baru -->
    <div class="modal-overlay" id="overlayTambah" onclick="tutupModalTambah()"></div>
    <div class="bottom-sheet" id="sheetTambah">
        <div class="sheet-handle"></div>
        <h3 style="margin: 0 0 16px; font-size: 18px;">Tambah Akun Baru</h3>
        <form action="/api/save-account" method="POST">
            <input type="hidden" name="action" value="add">
            <input type="hidden" name="redirect" value="/inventory">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Nickname</label>
            <input type="text" name="nick" class="input-box" placeholder="Contoh: arda1" required style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">ID Game (User ID + Zone)</label>
            <input type="text" name="id" class="input-box" placeholder="Contoh: 1599704184(4458)" required style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn" style="flex: 1; background: #eee;" onclick="tutupModalTambah()">Batal</button>
                <button type="submit" class="btn-primary" style="flex: 1;"><i class="ph-bold ph-check"></i> Simpan</button>
            </div>
        </form>
    </div>

<div class="modal-overlay" id="overlay" onclick="tutupModal()"></div>
    <div class="bottom-sheet" id="sheet">
        <div class="sheet-handle"></div>
        <div style="text-align: center; margin-bottom: 15px;">
            <h3 id="modalTitle" style="margin:0; font-size: 20px;">-</h3>
            <p id="modalSub" style="margin: 5px 0 0; color: #888; font-size: 14px;">-</p>
        </div>

        <div style="background: #f0f2f5; border-radius: 12px; padding: 10px 14px; margin-bottom: 15px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 6px;">Mode input:</div>
            <div style="display: flex; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1;">
                    <input type="radio" name="modeInput" value="0" id="modeBiasa" checked>
                    <span>Biasa (real)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1;">
                    <input type="radio" name="modeInput" value="1" id="modePenyesuaian">
                    <span>Penyesuaian (hutang)</span>
                </label>
            </div>
        </div>

        <div class="tabs-nav">
            <div class="tab-item active" onclick="gantiTab('tab-inject', this)">
                <i class="ph-bold ph-syringe" style="font-size: 18px;"></i> Inject
            </div>
            <div class="tab-item" onclick="gantiTab('tab-koreksi', this)">
                <i class="ph-bold ph-sliders-horizontal" style="font-size: 18px;"></i> Koreksi
            </div>
            <div class="tab-item" onclick="gantiTab('tab-hapus', this)">
                <i class="ph-bold ph-trash-simple" style="font-size: 18px;"></i> Hapus
            </div>
        </div>

        <div id="tab-inject" class="tab-content active">
            <form action="/api/update-stok" method="POST">
                <input type="hidden" name="nickname" class="target-nick">
                <input type="hidden" name="action" value="inject_wdp">
                <input type="hidden" name="penyesuaian" id="penyesuaianInject" value="0">
                
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Paket WDP Masuk:</p>
                <div class="grid-3">
                    <button type="button" class="btn-big" onclick="setWdp(1)"><i class="ph-bold ph-package"></i> 1x</button>
                    <button type="button" class="btn-big" onclick="setWdp(2)"><i class="ph-bold ph-package"></i> 2x</button>
                    <button type="button" class="btn-big" onclick="setWdp(5)"><i class="ph-bold ph-package"></i> 5x</button>
                </div>
                <div class="flex-row" style="gap: 10px;">
                    <input type="number" name="amount" id="wdpInput" class="input-box" placeholder="Jml Paket WDP" required style="margin-bottom:0;">
                    <button type="submit" class="btn-primary" style="width: 120px; margin-bottom:0;">Simpan</button>
                </div>
            </form>
        </div>

        <div id="tab-koreksi" class="tab-content">
            <form action="/api/update-stok" method="POST" class="form-koreksi" style="margin-bottom: 15px;">
                <input type="hidden" name="nickname" class="target-nick">
                <input type="hidden" name="action" value="manual_dm">
                <input type="hidden" name="penyesuaian" class="penyesuaianKoreksi" value="0">
                <label style="font-size:12px; color:#666;">Edit Diamond Manual</label>
                <div class="flex-row" style="gap:10px;">
                    <input type="number" name="amount" class="input-box" placeholder="+/- (Contoh: -50)" style="margin:0">
                    <button type="submit" class="btn" style="width:auto; background:#eee; margin:0">Ok</button>
                </div>
            </form>
            <form action="/api/update-stok" method="POST" class="form-koreksi">
                <input type="hidden" name="nickname" class="target-nick">
                <input type="hidden" name="action" value="manual_days">
                <input type="hidden" name="penyesuaian" class="penyesuaianKoreksi" value="0">
                <label style="font-size:12px; color:#666;">Edit Hari Manual</label>
                <div class="flex-row" style="gap:10px;">
                    <input type="number" name="days" class="input-box" placeholder="+/- (Contoh: +1)" style="margin:0">
                    <button type="submit" class="btn" style="width:auto; background:#eee; margin:0">Ok</button>
                </div>
            </form>
        </div>

        <div id="tab-hapus" class="tab-content">
             <form action="/api/save-account" method="POST" onsubmit="return confirm('Hapus akun ini permanen? Stok akan hilang.');">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="oldNick" class="target-nick">
                <input type="hidden" name="redirect" value="/inventory">
                <button type="submit" class="btn-danger"><i class="ph-bold ph-trash"></i> Hapus Akun</button>
            </form>
        </div>
    </div>

    <%- include('./bottom_nav') %>

    <script>
        function syncPenyesuaian() {
            var val = document.getElementById('modePenyesuaian') && document.getElementById('modePenyesuaian').checked ? '1' : '0';
            var inj = document.getElementById('penyesuaianInject');
            if (inj) inj.value = val;
            document.querySelectorAll('.penyesuaianKoreksi').forEach(function(el) { el.value = val; });
        }

        function bukaKelola(nick, id, dm, days) {
            document.getElementById('modalTitle').innerText = nick;
            document.getElementById('modalSub').innerText = 'ID: ' + id + ' • ' + (parseInt(dm) || 0).toLocaleString() + ' DM • ' + days + ' Hari';
            document.querySelectorAll('.target-nick').forEach(function(el) { el.value = nick; });
            syncPenyesuaian();
            gantiTab('tab-inject', document.querySelector('.tab-item'));
            document.getElementById('overlay').classList.add('active');
            document.getElementById('sheet').classList.add('active');
        }

        function tutupModal() {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('sheet').classList.remove('active');
        }

        function bukaModalTambah() {
            document.getElementById('overlayTambah').classList.add('active');
            document.getElementById('sheetTambah').classList.add('active');
        }
        function tutupModalTambah() {
            document.getElementById('overlayTambah').classList.remove('active');
            document.getElementById('sheetTambah').classList.remove('active');
        }

        function gantiTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function setWdp(n) { document.getElementById('wdpInput').value = n; }

        document.querySelectorAll('input[name="modeInput"]').forEach(function(radio) {
            radio.addEventListener('change', syncPenyesuaian);
        });
    </script>
</body>
</html>