<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gudang Stok</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .btn-action { padding: 8px 15px; border-radius: 8px; font-weight: 600; }
        tr td { vertical-align: middle; padding: 15px 10px !important; }
        .badge-wdp { background-color: #6610f2; color: white; font-size: 0.75rem; }
        .swal-custom-input { border: none; background: #f8f9fa; font-size: 1.5rem; font-weight: bold; color: #212529; }
        .swal2-actions { flex-direction: row-reverse !important; justify-content: center !important; gap: 10px; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .pending-blink { animation: blink 1.5s infinite; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid p-0 bg-white shadow-sm sticky-top">
        <div class="d-flex align-items-center p-3">
            <a href="/" class="btn btn-light me-3 border">‚Üê</a>
            <h5 class="fw-bold m-0">üì¶ Gudang Stok</h5>
        </div>
    </div>

    <div class="container-fluid mt-2 pb-5 px-0">
        <div class="bg-white">
            <table class="table table-striped mb-0">
                <thead>
                    <tr class="table-light">
                        <th class="ps-3 py-3">Akun</th>
                        <th class="py-3">Stok Real</th>
                        <th class="py-3">WDP</th> 
                        <th class="text-end pe-3 py-3">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% accounts.forEach(acc => { 
                        // --- LOGIKA TAMPILAN TANDA KUNING ---
                        let isPending = acc.pending_wdp === true;
                        let infoPending = acc.last_req ? `(+${acc.last_req.dm})` : '';
                    %>
                    <tr class="<%= isPending ? 'table-warning' : '' %>">
                        <td class="ps-3">
                            <span class="fw-bold d-block text-dark">
                                <%= acc.nick %>
                                <% if(isPending) { %>
                                    <span class="badge bg-danger text-white ms-1 pending-blink">‚ö†Ô∏è BUTUH TOPUP <%= infoPending %></span>
                                <% } %>
                            </span>
                            <small class="text-muted" style="font-size: 0.7rem;"><%= acc.id %></small>
                        </td>
                        <td>
                            <span class="badge <%= acc.diamond < 0 ? 'bg-danger' : 'bg-success' %> rounded-pill">
                                <%= acc.diamond %>
                            </span>
                        </td>
                        <td>
                            <% if(acc.wdp_days > 0) { %>
                                <span class="badge badge-wdp rounded-pill">
                                    <%= acc.wdp_days %> Hari
                                    <br><small>(+<%= acc.wdp_days * 20 %>)</small>
                                </span>
                            <% } else { %> <span class="text-muted small">-</span> <% } %>
                        </td>
                        <td class="text-end pe-3">
                            <button onclick="editStok('<%= acc.nick %>', <%= acc.diamond %>, <%= acc.wdp_days || 0 %>)" class="btn btn-primary btn-action text-white btn-sm">
                                üìù Atur
                            </button>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

<script>
    function editStok(nick, currentDm, currentWdp) {
        Swal.fire({
            title: `${nick}`,
            html: `
                <div class="mb-3">
                    <label class="small text-muted mb-1">Stok Diamond (Real)</label>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-danger btn-sm" type="button" onclick="modDm(-20)">-20</button>
                        <input type="number" id="swal-input-dm" class="form-control text-center swal-custom-input" value="${currentDm}">
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="modDm(20)">+20</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="small text-muted mb-1">Sisa Hari WDP</label>
                    <input type="number" id="swal-input-wdp" class="form-control text-center swal-custom-input py-2" style="font-size: 1.2rem;" value="${currentWdp}">
                </div>

                <div class="form-check form-switch d-flex justify-content-center align-items-center gap-2 mb-3 p-2 border rounded bg-light">
                    <input class="form-check-input" type="checkbox" id="swal-adjust-mode" style="transform: scale(1.3);">
                    <label class="form-check-label fw-bold text-secondary small pt-1" for="swal-adjust-mode">
                        Mode Penyesuaian Data<br>
                        <span style="font-size:0.65rem; font-weight:normal;">(Ubah angka TANPA lapor ke Web)</span>
                    </label>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-danger w-100 py-2" onclick="paketWdp('min')">
                            <div class="fw-bold">‚ûñ KURANGI</div>
                            <div style="font-size: 0.65rem; opacity: 0.8">-80 DM & 7 Hari</div>
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-success w-100 py-2" onclick="paketWdp('add')">
                            <div class="fw-bold">‚ûï TAMBAH</div>
                            <div style="font-size: 0.65rem; opacity: 0.8">+80 DM & 7 Hari</div>
                        </button>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'SIMPAN',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#6610f2', 
            reverseButtons: true,
            preConfirm: () => {
                // KIRIM DATA KE BACKEND
                return { 
                    nick, 
                    amount: document.getElementById('swal-input-dm').value,
                    wdp: document.getElementById('swal-input-wdp').value,
                    // PENTING: Kirim status checkbox ini!
                    is_adjustment: document.getElementById('swal-adjust-mode').checked
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/api/update-stok', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(result.value)
                }).then(() => window.location.reload());
            }
        });
    }

    function modDm(val) {
        const el = document.getElementById('swal-input-dm');
        el.value = parseInt(el.value) + val;
    }

    function paketWdp(mode) {
        const elDm = document.getElementById('swal-input-dm');
        const elWdp = document.getElementById('swal-input-wdp');
        let curDm = parseInt(elDm.value) || 0;
        let curWdp = parseInt(elWdp.value) || 0;

        if (mode === 'add') {
            elDm.value = curDm + 80;   
            elWdp.value = curWdp + 7;  
        } else if (mode === 'min') {
            elDm.value = curDm - 80;   
            elWdp.value = curWdp - 7;  
        }
    }
</script>
</body>
</html>
