<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f0f2f5; padding-bottom: 80px; }
        .order-card { border-radius: 12px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .search-box { border-radius: 20px; border: 1px solid #ced4da; padding-left: 20px; }
        .btn-action { font-size: 0.85rem; font-weight: 600; padding: 8px 0; }
        .target-text { font-family: monospace; font-size: 0.9rem; color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container-fluid p-0 bg-white shadow-sm sticky-top mb-3">
        <div class="d-flex align-items-center p-3">
            <a href="/" class="btn btn-light me-3 border btn-lg">‚Üê</a>
            <h5 class="fw-bold m-0">Monitor Pesanan</h5>
        </div>
        <div class="px-3 pb-3">
            <ul class="nav nav-pills w-100 nav-fill p-1 bg-light rounded" id="myTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link rounded shadow-sm <%= searchQuery ? '' : 'active' %>" id="active-tab" data-bs-toggle="tab" data-bs-target="#active">
                        Berlangsung (<%= active.length %>)
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link rounded <%= searchQuery ? 'active' : '' %>" id="history-tab" data-bs-toggle="tab" data-bs-target="#history">
                        Riwayat
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="container px-3">
        <div class="tab-content">
            <div class="tab-pane fade <%= searchQuery ? '' : 'show active' %>" id="active">
                <% active.forEach(order => { 
                    const now = Date.now();
                    const isReady = now >= order.due_date;
                    const diffDays = Math.ceil((order.due_date - now) / (1000 * 60 * 60 * 24)); 
                    const gameId = order.executor_id || "ID Tidak Ditemukan";
                    
                    const waktuDetail = new Date(order.due_date).toLocaleString('id-ID', { 
                        day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' 
                    }).replace(/\./g, ':'); 
                %>
                <div class="card order-card <%= isReady ? 'border-start border-5 border-success' : 'border-start border-5 border-warning' %>">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-secondary align-self-start"><%= order.item_name %></span>
                            <div class="text-end">
                                <span class="badge <%= isReady ? 'bg-success' : 'bg-warning text-dark' %>">
                                    <%= isReady ? 'SIAP KIRIM' : 'H-'+diffDays %>
                                </span>
                                <small class="d-block text-muted mt-1 fw-bold" style="font-size: 0.75rem;">
                                    ‚è∞ <%= waktuDetail %>
                                </small>
                            </div>
                        </div>
                        
                        <h6 class="fw-bold mb-1"><%= order.buyer_name %></h6>
                        <small class="text-muted d-block mb-1"><%= order.id %></small>
                        
                        <div class="bg-light p-2 rounded mb-3 border">
                            <div class="row g-0">
                                <div class="col-6 border-end pe-2">
                                    <small class="d-block text-secondary fw-bold" style="font-size: 0.7rem;">PENERIMA (BUYER)</small>
                                    <div class="target-text text-truncate"><%= order.target_data %></div>
                                </div>
                                <div class="col-6 ps-2">
                                    <small class="d-block text-secondary fw-bold" style="font-size: 0.7rem;">PENGIRIM (ADMIN)</small>
                                    <div class="text-success fw-bold text-truncate"><%= order.executor %></div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button onclick="showStrukOptions('<%= order.id %>', '<%= order.item_name %>', <%= order.created_at %>, '<%= order.target_data %>', '<%= order.executor %>', '<%= gameId %>')" class="btn btn-primary btn-sm fw-bold shadow-sm">
                                üìú Buat Struk / Receipt
                            </button>

                            <div class="d-flex gap-2 mt-1">
                                <form action="/cancel-order" method="POST" class="flex-fill" onsubmit="return confirm('Yakin BATALKAN order ini? Stok akan dikembalikan.')">
                                    <input type="hidden" name="id" value="<%= order.id %>">
                                    <button class="btn btn-outline-danger btn-sm w-100 btn-action">‚úñ Batal</button>
                                </form>

                                <% if(isReady) { %>
                                <form action="/finish-order" method="POST" class="flex-fill" onsubmit="return confirm('Pastikan item SUDAH DIKIRIM di game sebelum klik ini!')">
                                    <input type="hidden" name="id" value="<%= order.id %>">
                                    <button class="btn btn-success btn-sm w-100 btn-action">‚úÖ Selesai</button>
                                </form>
                                <% } else { %>
                                    <button class="btn btn-light btn-sm flex-fill disabled btn-action">‚è≥ Tunggu</button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>
                <% if(active.length === 0) { %> <div class="text-center mt-5 text-muted">Tidak ada pesanan aktif.</div> <% } %>
            </div>

            <div class="tab-pane fade <%= searchQuery ? 'show active' : '' %>" id="history">
                <form action="/orders" method="GET" class="mb-3">
                    <input type="text" name="q" class="form-control search-box" placeholder="üîç Cari ID Order / ID Game / Nama..." value="<%= searchQuery %>">
                </form>
                <div class="list-group list-group-flush rounded shadow-sm">
                    <% history.forEach(h => { const tgl = new Date(h.created_at).toLocaleDateString('id-ID'); %>
                        <div class="list-group-item p-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <h6 class="mb-0 fw-bold"><%= h.buyer_name %></h6>
                                <span class="badge <%= h.status === 'CANCELLED' ? 'bg-danger' : 'bg-success' %>"><%= h.status %></span>
                            </div>
                            <small class="text-muted d-block"><%= h.item_name %></small>
                            <small class="text-muted d-block mt-1" style="font-size: 0.8rem;">
                                ID: <%= h.id %><br>Target: <%= h.target_data %>
                            </small>
                            
                            <% if(h.status === 'DONE') { %>
                                <button onclick="showSentInfoOptions('<%= h.id %>', '<%= h.item_name %>', '<%= h.target_data %>')" class="btn btn-sm btn-outline-success w-100 mt-2 fw-bold">
                                    üì± Info Sudah Dikirim
                                </button>
                            <% } %>

                            <div class="d-flex justify-content-between align-items-end mt-2">
                                <span class="badge bg-light text-dark border">Via: <%= h.executor %></span>
                                <small class="text-muted fst-italic"><%= tgl %></small>
                            </div>
                        </div>
                    <% }) %>
                    <% if(history.length === 0) { %> <div class="text-center py-3 text-muted">Tidak ditemukan.</div> <% } %>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // 1. STRUK PEMBELIAN (ADD FRIEND) - FIXED SPACING
        // ==========================================
        function showStrukOptions(orderId, item, createdAt, buyerData, adminNick, adminId) {
            Swal.fire({
                title: 'Pilih Bahasa Struk',
                text: 'Format Pesanan (Add Friend)',
                icon: 'question',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'üáÆüá© Indonesia',
                denyButtonText: 'üá¨üáß English',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#0d6efd',
                denyButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) generateStruk('id', orderId, item, createdAt, buyerData, adminNick, adminId);
                else if (result.isDenied) generateStruk('en', orderId, item, createdAt, buyerData, adminNick, adminId);
            });
        }

        function generateStruk(lang, orderId, item, createdAt, buyerData, adminNickStr, adminIdStr) {
            const dateObj = new Date(createdAt);
            const wibTime = dateObj.getTime() + (7 * 3600000); 
            const wibDateObj = new Date(wibTime);
            const hourWIB = wibDateObj.getUTCHours(); 
            let addDays = hourWIB >= 15 ? 8 : 7;
            const targetDate = new Date(wibTime);
            targetDate.setUTCDate(targetDate.getUTCDate() + addDays);
            
            const d = targetDate.getUTCDate();
            const m = targetDate.getUTCMonth() + 1;
            const y = targetDate.getUTCFullYear();
            
            let dateString = "";
            if (lang === 'id') dateString = `${d}/${m}/${y}, pukul 15:00 WIB`;
            else dateString = `${m}/${d}/${y}, 08:00 UTC`;

            const nicks = adminNickStr.split(',');
            const ids = adminIdStr.split(',');
            let senderList = "";
            
            if (nicks.length === 1) {
                senderList = `Nick : ${nicks[0]}\nID   : ${ids[0]}`;
            } else {
                for (let i = 0; i < nicks.length; i++) {
                    senderList += `${i+1}. Nick : ${nicks[i]}\n   ID   : ${ids[i] || '-'}\n`;
                }
                senderList = senderList.trim();
            }

            // PERBAIKAN SPASI PRESISI DISINI
            let text = "";
            if (lang === 'id') {
                text = `==============================
      RINCIAN PEMESANAN
==============================

DATA PESANAN
No.           : ${orderId}
Item         : ${item}
Target      : ${buyerData}
Tgl Kirim  : ${dateString}

INFO PENGIRIM
${senderList}
------------------------------
PENTING:
Silakan add (tambah teman) akun
di atas agar gift bisa dikirim.
==============================`;
            } else {
                text = `==============================
      ORDER DETAILS
==============================

ORDER DATA
No.           : ${orderId}
Item         : ${item}
Target      : ${buyerData}
Ship date : ${dateString}

SENDER INFO
${senderList}
------------------------------
IMPORTANT:
Please add (add as a friend) the accounts
above so the gift can be sent.
==============================`;
            }

            copyToClipboard(text, lang === 'id' ? '‚úÖ Struk ID Disalin!' : '‚úÖ Receipt EN Copied!');
        }

        // ==========================================
        // 2. INFO SUDAH DIKIRIM (FORMAT NICK ID ZONE)
        // ==========================================
        function showSentInfoOptions(orderId, item, targetData) {
            Swal.fire({
                title: 'Info Sudah Dikirim',
                text: 'Pilih bahasa pesan konfirmasi',
                icon: 'success',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'üáÆüá© Indonesia',
                denyButtonText: 'üá¨üáß English',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#198754',
                denyButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) generateSentInfo('id', orderId, item, targetData);
                else if (result.isDenied) generateSentInfo('en', orderId, item, targetData);
            });
        }

        function generateSentInfo(lang, orderId, item, targetData) {
            // FORMAT DB: "123456 (1234) Nickname"
            // OUTPUT: "Nickname 123456 (1234)"
            
            let finalTarget = targetData;
            const splitIdx = targetData.indexOf(')');
            
            if (splitIdx !== -1) {
                const idZone = targetData.substring(0, splitIdx + 1).trim(); // "123456 (1234)"
                const nick = targetData.substring(splitIdx + 1).trim(); // "Nickname"
                finalTarget = `${nick} ${idZone}`;
            }

            let text = "";
            if (lang === 'id') {
                text = `Halo Kak,
Pesanan ${item} (${orderId}) telah berhasil dikirim.
Dikirim ke akun: ${finalTarget}

Terima kasih telah berbelanja di Imam Store.
Silakan cek katalog kami untuk promo dan produk menarik lainnya.
Kami tunggu pesanan berikutnya. Happy Gaming! üåü`;
            } else {
                text = `Hello,
Your order ${item} (${orderId}) has been successfully sent.
Delivered to account: ${finalTarget}

Thank you for shopping at Imam Store.
Feel free to check our catalog for other products and promos.
We look forward to your next order. Happy gaming! üåü`;
            }

            copyToClipboard(text, lang === 'id' ? '‚úÖ Info ID Disalin!' : '‚úÖ Info EN Copied!');
        }

        function copyToClipboard(text, successMsg) {
            navigator.clipboard.writeText(text).then(() => {
                Swal.fire({ icon: 'success', title: successMsg, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            }).catch(err => {
                Swal.fire({ icon: 'error', title: 'Gagal menyalin', text: err });
            });
        }
    </script>
</body>
</html>
